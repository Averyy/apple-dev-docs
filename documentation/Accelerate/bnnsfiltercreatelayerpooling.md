# BNNSFilterCreateLayerPooling(_:_:)

**Framework**: Accelerate  
**Kind**: func

Returns a new pooling layer.

**Availability**:
- iOS 14.0+
- iPadOS 14.0+
- Mac Catalyst 14.0+
- macOS 11.0+
- tvOS 14.0+
- visionOS 1.0+
- watchOS 7.0+

## Declaration

```swift
func BNNSFilterCreateLayerPooling(_ layer_params: UnsafePointer<BNNSLayerParametersPooling>, _ filter_params: UnsafePointer<BNNSFilterParameters>?) -> BNNSFilter?
```

#### Discussion

Use a pooling layer to downsample an input, selecting, for example, the average or the maximum value in a specified kernel size. The following figure illustrates how a 2 x 2 maximum pooling kernel samples each 2 x 2 block of values of 4 x 4 source. The highlighted block contains the values `[3, 4, 0, 0]`, so the maximum value passed to the destination element in `output` is `4`.

![Figure that shows a two dimensional four times four source matrix downsampled using a two times two pooling kernel that returns a three times three result. The operation writes the maximum value of each two times two block from the source matrix to the result.](https://docs-assets.developer.apple.com/published/270ddffd5acbd5245928a01069909a5d/media-3633103%402x.png)

The following code shows how you apply pooling to the input in the above figure. Note that the input is a 2 x 2 x 1 [`BNNSDataLayoutImageCHW`](bnnsdatalayoutimagechw.md) tensor. Definie [`x_padding`](bnnslayerparameterspooling/x_padding.md) and [`y_padding`](bnnslayerparameterspooling/y_padding.md) as 1 to add zero padding:

```swift
let input: [Float] = [1, 2,
                      3, 4]

var output = [Float](repeating: 0, count: 9)

let inDescriptor = BNNSNDArrayDescriptor(flags: BNNSNDArrayFlags(0),
                                         layout: BNNSDataLayoutImageCHW,
                                         size: (2, 2, 1, 0, 0, 0, 0, 0),
                                         stride: (0, 0, 0, 0, 0, 0, 0, 0),
                                         data: nil,
                                         data_type: .float,
                                         table_data: nil,
                                         table_data_type: .float,
                                         data_scale: 0,
                                         data_bias: 0)

let outDescriptor = BNNSNDArrayDescriptor(flags: BNNSNDArrayFlags(0),
                                          layout: BNNSDataLayoutImageCHW,
                                          size: (3, 3, 1, 0, 0, 0, 0, 0),
                                          stride: (0, 0, 0, 0, 0, 0, 0, 0),
                                          data: nil,
                                          data_type: .float,
                                          table_data: nil,
                                          table_data_type: .float,
                                          data_scale: 0,
                                          data_bias: 0)

var parameters = BNNSLayerParametersPooling(i_desc: inDescriptor,
                                            o_desc: outDescriptor,
                                            bias: BNNSNDArrayDescriptor(),
                                            activation: .identity,
                                            pooling_function: .max    ,
                                            k_width: 2,
                                            k_height: 2,
                                            x_stride: 1,
                                            y_stride: 1,
                                            x_dilation_stride: 0,
                                            y_dilation_stride: 0,
                                            x_padding: 1,
                                            y_padding: 1,
                                            pad: (0, 0, 0, 0))

let filter = BNNSFilterCreateLayerPooling(&parameters, nil)

defer {
    BNNSFilterDestroy(filter)
}

BNNSPoolingFilterApplyBatch(filter, 1,
                            input, input.count,
                            &output, output.count,
                            nil, 0)
```

On return, `output` contains the following values:

```swift
[ 1.0, 2.0, 2.0, 
  3.0, 4.0, 4.0, 
  3.0, 4.0, 4.0 ]
```

##### Unmax Pooling

Use [`BNNSPoolingFunctionUnMax`](bnnspoolingfunctionunmax.md) in conjunction with the indices generated by [`BNNSPoolingFunctionMax`](bnnspoolingfunctionmax.md) to partially recreate the original data of a maximum pooling operation. UnMax pooling is a partial inverse of maximum pooling that sets all non-maximal values to zero.

For example, given the following input data:

```swift
let input: [Float] = [1, 1, 1, 9,
                      1, 9, 9, 1,
                      1, 1, 1, 1,
                      1, 9, 1, 9]
```

Use [`BNNSPoolingFilterApplyBatch(_:_:_:_:_:_:_:_:)`](bnnspoolingfilterapplybatch(_:_:_:_:_:_:_:_:).md) to perform the maximum pooling and populate an indices array with positional information of maximum elements in each window:

```swift
var output = [Float](repeating: 0, count: 3 * 3)

let inDescriptor = BNNSNDArrayDescriptor(flags: BNNSNDArrayFlags(0),
                                         layout: BNNSDataLayoutImageCHW,
                                         size: (4, 4, 1, 0, 0, 0, 0, 0),
                                         stride: (0, 0, 0, 0, 0, 0, 0, 0),
                                         data: nil,
                                         data_type: .float,
                                         table_data: nil,
                                         table_data_type: .float,
                                         data_scale: 0,
                                         data_bias: 0)

let outDescriptor = BNNSNDArrayDescriptor(flags: BNNSNDArrayFlags(0),
                                          layout: BNNSDataLayoutImageCHW,
                                          size: (3, 3, 1, 0, 0, 0, 0, 0),
                                          stride: (0, 0, 0, 0, 0, 0, 0, 0),
                                          data: nil,
                                          data_type: .float,
                                          table_data: nil,
                                          table_data_type: .float,
                                          data_scale: 0,
                                          data_bias: 0)

var parameters = BNNSLayerParametersPooling(i_desc: inDescriptor,
                                            o_desc: outDescriptor,
                                            bias: BNNSNDArrayDescriptor(),
                                            activation: .identity,
                                            pooling_function: .max    ,
                                            k_width: 2,
                                            k_height: 2,
                                            x_stride: 1,
                                            y_stride: 1,
                                            x_dilation_stride: 0,
                                            y_dilation_stride: 0,
                                            x_padding: 0,
                                            y_padding: 0,
                                            pad: (0, 0, 0, 0))

let filter = BNNSFilterCreateLayerPooling(&parameters, nil)

defer {
    BNNSFilterDestroy(filter)
}

var indices = [Int](repeating: 0, count: input.count)

BNNSPoolingFilterApplyBatch(filter, 1,
                            input, input.count,
                            &output, output.count,
                            &indices, indices.count)
```

To perform the UnMax pooling, reuse the parameters structure, but swap the input and output descriptors:

```swift
var recreatedInput = [Float](repeating: 0, count: input.count)

parameters.i_desc = outDescriptor
parameters.o_desc = inDescriptor
parameters.pooling_function = BNNSPoolingFunctionUnMax

let unMaxFilter = BNNSFilterCreateLayerPooling(&parameters, nil)

defer {
    BNNSFilterDestroy(unMaxFilter)
}

BNNSPoolingFilterApplyBatch(unMaxFilter, 1,
                            output, output.count,
                            &recreatedInput, recreatedInput.count,
                            &indices, indices.count)
```

On return, `recreatedInput` is similar to `input`, but the non-maximal values are zero:

```swift
[ 0.0, 0.0, 0.0, 9.0,
  0.0, 9.0, 9.0, 0.0,
  0.0, 0.0, 0.0, 0.0,
  0.0, 9.0, 0.0, 9.0 ]
```

## Parameters

- `layer_params`: Layer parameters.
- `filter_params`: The filter runtime parameters.

## See Also

- [struct BNNSPoolingLayerParameters](bnnspoolinglayerparameters.md)
  A structure containing pooling layer parameters.
- [func BNNSFilterCreatePoolingLayer(UnsafePointer<BNNSImageStackDescriptor>, UnsafePointer<BNNSImageStackDescriptor>, UnsafePointer<BNNSPoolingLayerParameters>, UnsafePointer<BNNSFilterParameters>?) -> BNNSFilter?](bnnsfiltercreatepoolinglayer(_:_:_:_:).md)
  Returns a pooling  filter, initialized with input, output, layer, and filter parameters.
- [class PoolingLayer](bnns/poolinglayer.md)
  A layer object that wraps a pooling filter and manages its deinitialization.
- [struct BNNSPoolingFunction](bnnspoolingfunction.md)
  Constants that describe pooling functions.
- [var BNNSPoolingFunctionAverage: BNNSPoolingFunction](bnnspoolingfunctionaverage.md)
- [var BNNSPoolingFunctionMax: BNNSPoolingFunction](bnnspoolingfunctionmax.md)
- [struct BNNSLayerParametersPooling](bnnslayerparameterspooling.md)
  A structure that contains the parameters of a pooling layer.
- [func BNNSPoolingFilterApplyBatch(BNNSFilter?, Int, UnsafeRawPointer, Int, UnsafeMutableRawPointer, Int, UnsafeMutablePointer<Int>?, Int) -> Int32](bnnspoolingfilterapplybatch(_:_:_:_:_:_:_:_:).md)
  Applies a pooling filter to a set of input objects, writing the result to a set of output objects.
- [func BNNSPoolingFilterApplyBackwardBatch(BNNSFilter?, Int, UnsafeRawPointer?, Int, UnsafeMutablePointer<BNNSNDArrayDescriptor>?, Int, UnsafeRawPointer?, Int, UnsafeMutablePointer<BNNSNDArrayDescriptor>, Int, UnsafeMutablePointer<BNNSNDArrayDescriptor>?, UnsafePointer<Int>?, Int) -> Int32](bnnspoolingfilterapplybackwardbatch(_:_:_:_:_:_:_:_:_:_:_:_:_:).md)
  Applies a pooling filter backward to generate gradients.
- [func BNNSPoolingFilterApplyBatchEx(BNNSFilter?, Int, UnsafeRawPointer, Int, UnsafeMutableRawPointer, Int, BNNSDataType, UnsafeMutableRawPointer?, Int) -> Int32](bnnspoolingfilterapplybatchex(_:_:_:_:_:_:_:_:_:).md)
  Applies a pooling filter to a set of input objects with support for multiple data types for indices.
- [func BNNSPoolingFilterApplyBackwardBatchEx(BNNSFilter?, Int, UnsafeRawPointer?, Int, UnsafeMutablePointer<BNNSNDArrayDescriptor>?, Int, UnsafeRawPointer?, Int, UnsafeMutablePointer<BNNSNDArrayDescriptor>, Int, UnsafeMutablePointer<BNNSNDArrayDescriptor>?, BNNSDataType, UnsafeRawPointer?, Int) -> Int32](bnnspoolingfilterapplybackwardbatchex(_:_:_:_:_:_:_:_:_:_:_:_:_:_:).md)
  Applies a pooling filter backward to generate gradients with support for multiple data types for indices.


---

*[View on Apple Developer](https://developer.apple.com/documentation/accelerate/bnnsfiltercreatelayerpooling(_:_:))*